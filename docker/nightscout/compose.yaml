services:
  mongo:
    container_name: "nightscout-mongodb"
    image: "mongo:8.0"
    restart: "unless-stopped"
    command: "--quiet --wiredTigerCacheSizeGB 0.25"
    volumes:
      - "${DOCKER_DATA_DIR:?error}/${COMPOSE_PROJECT_NAME:?error}/mongo-data:/data/db:z"
      - "${DOCKER_DATA_DIR:?error}/${COMPOSE_PROJECT_NAME:?error}/mongo-config:/data/configdb:z"
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${NIGHTSCOUT_DB_USERNAME:?error}"
      MONGO_INITDB_ROOT_PASSWORD: "${NIGHTSCOUT_DB_PASSWORD:?error}"
  nightscout:
    image: "nightscout/cgm-remote-monitor:15.0.3"
    container_name: "nightscout"
    restart: "unless-stopped"
    depends_on:
      - "mongo"
    networks:
      - "proxy"
      - "default"
    ports:
      - "1337:1337"
    environment:
      # https://github.com/nightscout/cgm-remote-monitor#environment
      NODE_ENV: "production"
      TZ: "Europe/Berlin"
      INSECURE_USE_HTTP: "true"
      SECURE_HSTS_HEADER: "false"
      MONGO_CONNECTION: "mongodb://${NIGHTSCOUT_DB_USERNAME:?error}:${NIGHTSCOUT_DB_PASSWORD:?error}@mongo:27017/nightscout?authSource=admin"
      API_SECRET: "${API_SECRET}"
      ENABLE: "careportal rawbg iob cors"
      AUTH_DEFAULT_ROLES: "denied"
      DISPLAY_UNITS: "mg/dl"
      TIME_FORMAT: "24"
      CUSTOM_TITLE: "TheConen's Nightscout"
      THEME: "colors"
      SHOW_FORECAST: "false"
      ALARM_TIMEAGO_WARN: "off"
      ALARM_TIMEAGO_URGENT: "off"
      ALARM_HIGH: "off"
      ALARM_LOW: "off"
      ALARM_URGENT_HIGH: "off"
      ALARM_URGENT_LOW: "off"
    labels:
      traefik.enable: true
      traefik.http.routers.nightscout.entrypoints: "websecure-internal,websecure-external"
      traefik.http.routers.nightscout.rule: "Host(`nightscout.${TRAEFIK_DOMAINNAME_1:?error}`)"
      traefik.http.routers.nightscout.service: "nightscout"
      traefik.http.services.nightscout.loadbalancer.server.port: 1337
  nightscout-reporter:
    container_name: "nightscout-reporter"
    build: "https://github.com/TheConen/nightscout-reporter-angular.git"
    pull_policy: "always"
    restart: "unless-stopped"
    configs:
        - source: "nginx-config"
          target: "/etc/nginx/conf.d/nginx.conf"
    networks:
      - "proxy"
    labels:
      traefik.enable: true
      traefik.http.routers.nightscout-reporter.entrypoints: "websecure-internal,websecure-external"
      traefik.http.routers.nightscout-reporter.rule: "Host(`nightscout-reporter.${TRAEFIK_DOMAINNAME_1:?error}`)"
      traefik.http.routers.nightscout-reporter.service: "nightscout-reporter"
      traefik.http.services.nightscout-reporter.loadbalancer.server.port: 80
networks:
  default: {}
  proxy:
    external: true
    name: "${TRAEFIK_NETWORK_NAME:-proxy}"
configs:
  nginx-config:
    content: |
      server {        
        index index.html;
        location / {
          try_files $$uri $$uri/ /index.html;
        }
      }
